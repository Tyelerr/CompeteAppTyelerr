# Recurring Template Status Redesign - Implementation Plan

## Overview

Separate "Tournament Instance Active" from "Recurring Template Active" to allow master tournaments to be archived as past instances while still generating future tournaments.

## Current Problem

- Generator depends on `status = 'active'` for master tournaments
- When a master tournament's date passes, the archive job sets `status = 'archived'`
- This stops the generator from creating future instances
- Result: Recurring series stop generating after the master is archived

## Solution

Add a new field `recurring_template_status` that controls whether the series should keep generating, independent of the tournament instance status.

---

## Implementation Steps

### Step 1: Database Schema Changes

**File**: `CompeteApp/sql/add_recurring_template_status.sql`

Add new column and enum type:

- Create enum type: `recurring_template_status_enum` with values: `active`, `paused`, `archived`
- Add column: `recurring_template_status` to `tournaments` table
- Set default value: `active`
- Migrate existing data: Set all recurring masters to `active`

### Step 2: Update Generator Function

**File**: `CompeteApp/sql/update_generate_recurring_tournaments_with_template_status.sql`

Modify `generate_recurring_tournaments_horizon()` to:

- Select masters using `recurring_template_status = 'active'` instead of `status = 'active'`
- Remove dependency on master tournament's `status` field
- Allow generation even when master has `status = 'archived'`

### Step 3: Update Archive Function

**File**: `CompeteApp/sql/update_archive_function_preserve_template_status.sql`

Modify `archive_expired_tournaments()` to:

- Continue archiving past tournaments (including masters)
- **NEVER** modify `recurring_template_status`
- Only change `status` field

### Step 4: Update TypeScript Interfaces

**File**: `CompeteApp/hooks/InterfacesGlobal.tsx`

Add `recurring_template_status` field to tournament interface:

```typescript
recurring_template_status?: 'active' | 'paused' | 'archived';
```

### Step 5: Update CRUD Operations

**File**: `CompeteApp/ApiSupabase/CrudTournament.tsx`

Update tournament creation/editing to handle `recurring_template_status`:

- When creating recurring master: set `recurring_template_status = 'active'`
- Add ability to pause/archive template (admin only)
- Preserve template status during updates

### Step 6: Update Admin UI (Optional Enhancement)

**File**: `CompeteApp/screens/Admin/ModalAdminTournamentEditor.tsx`

Add controls for managing template status:

- Show template status for recurring masters
- Allow admins to pause/archive recurring series
- Display warning when changing template status

### Step 7: Testing

**File**: `CompeteApp/test_recurring_template_status.js`

Create test script to verify:

- Masters can be archived while template stays active
- Generator continues working with archived masters
- Archive job doesn't affect template status
- New tournaments are generated correctly

### Step 8: Documentation

**File**: `CompeteApp/HOW_RECURRING_TOURNAMENTS_WORK_V2.md`

Update documentation to explain:

- Difference between instance status and template status
- How the new system works
- Migration guide for existing data

---

## Key Rules

### Generator Rules

✅ Select masters using:

- `is_recurring = true`
- `is_recurring_master = true`
- `recurring_template_status = 'active'`

❌ Do NOT depend on:

- Master tournament's `status` field

### Archive Job Rules

✅ Can do:

- Set tournament `status` to `'archived'` (including masters)
- Move tournaments to archive table

❌ Must NOT do:

- Change `recurring_template_status` field
- Stop generation based on master status

### Instance Generation Rules

✅ Determine latest generated by:

- Looking up tournaments with same `recurring_series_id`
- Finding max `start_date` among child instances

✅ Generate until:

- Horizon is covered (60 days ahead)
- Skip past dates
- Prevent duplicates via unique constraint

---

## Migration Strategy

1. **Add column** with default value `'active'`
2. **Migrate existing data**: Set all recurring masters to `'active'`
3. **Update functions** in order:
   - Generator first (to use new field)
   - Archive function second (to preserve new field)
4. **Test thoroughly** before deploying
5. **Update app code** to handle new field
6. **Deploy** database changes first, then app updates

---

## Rollback Plan

If issues occur:

1. Revert generator function to use `status = 'active'`
2. Keep `recurring_template_status` column (no harm)
3. Can re-attempt migration later

---

## Status: Ready for Implementation

Next Action: Create SQL migration files
